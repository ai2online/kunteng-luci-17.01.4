<%
    local fs = require "nixio.fs"
    local OEM = require "ktapi.oem"

    local adminNode = {
            {
                path = "luci",
                name = "home",
                img = "h_home",
                txt = "首页"
            },
            {
                path = "admin/settings",
                name = "settings",
                img = "h_set",
                txt = "设置"
            },
            {
                path = "admin/connect",
                name = "connect",
                img = "h_connect",
                txt = "连接"
            },
            {
                path = "admin/application",
                name = "application",
                img = "h_apply",
                txt = "应用"
            }
    }

    for i=#adminNode, 1, -1 do
        if REQUEST_URI:find(adminNode[i].path, 1, true) then
            adminNode[i].select = true
            adminNode[i].img = adminNode[i].img .. "_a"
            break
        end
    end
%>
<!DOCTYPE html>
<html lang="<%=luci.i18n.context.lang%>">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <meta http-equiv="X-UA-COMPATIBLE" content="IE=edge,chrome=1"/>
    <!--[if lt IE 9]
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]>-->

    <title><%=OEM.WEBSITE_TIELE%></title>
    <link rel="shortcut icon" href="<%=media%>/favicon.ico">
    <link rel="stylesheet" type="text/css" href="<%=resource%>/css/style.css">
    <link rel="stylesheet" type="text/css" href="<%=resource%>/css/set.css">
    <link rel="stylesheet" type="text/css" href="<%=resource%>/css/use.css">
    <%local files = fs.dir("/www" .. resource .. "/css/app/")
    if files then
        local f
        for f in files do%>
    <link type="text/css" rel="stylesheet" href="<%=resource%>/css/app/<%=f%>" />
        <%end
    end%>
    <script type="text/javascript" src="<%=resource%>/js/jquery-2.2.3.min.js"></script>
    <script type="text/javascript" src="<%=resource%>/js/toast.js"></script>
    <style>
        #G-lightbox-popup .lightbox-pic-view{background:url("<%=resource%>/images/loading2.gif") no-repeat;background-size:50px 50px;}
    </style>
</head>

<body>
<div class="header">
    <h4>
        <%if (fs.stat("/www" .. resource .. "/images/header-logo.png", "size") or 0) > 0 then%>
        <span style="vertical-align: middle"><img style="padding-right:16px;vertical-align: middle;" src="<%=resource%>/images/header-logo.png" alt=""/><%=OEM.WEBSITE_HOME%></span>
        <%else%>
        <span style="vertical-align: middle"><%=OEM.WEBSITE_HOME%></span>
        <%end%>
        <i class="hd-icon"><img src="<%=resource%>/images/header-icon.png" alt=""/></i>
        <p class="hd-right">
            <a href="#"><span id="restart" style="border:0;">重启路由器</span></a>
            <a href="#"><span id="reset">恢复出厂设置</span></a>
            <a href="<%=luci.dispatcher.build_url("admin", "logout")%>"><span>退出</span></a>
        </p>
    </h4>
</div>

<div class="nav">
    <div class="nav1">
        <ul>
            <%for i, v in ipairs(adminNode) do%>
            <li <%if not OEM.WEBSITE_CLOUD_HREF then%>style="width:25%"<%end%>>
                <a id="h_home" href="<%=luci.dispatcher.build_url("admin", v.name)%>">
                <img src="<%=resource%>/images/<%=v.img%>.png" alt="">
                <span><%=v.txt%></span>
                <!--<span <%if not v.select then%>style="display:none"<%end%>><%=striptags(translate(v.txt))%></span>-->
                </a>
            </li>
            <%end%>

            <%if OEM.WEBSITE_CLOUD_HREF then%>
            <li class="mgb">
                <a id="h_yun" href="<%=OEM.WEBSITE_CLOUD_HREF%>" target="_blank">
                    <!--<span style="display:none"><%:云平台%></span>-->
                    <img src="<%=resource%>/images/h_yun.png" alt="">
                    <span>云平台</span>
                </a>
            </li>
            <%end%>
        </ul>
    </div>
</div>

<script src="<%=resource%>/js/lightbox.js"></script>
<script type="text/javascript">
    $(function () {
        $(".hd-icon").click(function(){
            if($(".nav").css("display") == "none"){
                $(".nav").slideDown(500);
                setTimeout(function(){$(".header h4 .hd-right").slideDown(200);},200);

            }else{
                $(".header h4 .hd-right").slideUp(500);
                setTimeout(function(){$(".nav").slideUp(700);},0);
            }
        })

        //重启路由器
        $("#restart").click(function () {
            var c = confirm("是否确定重启路由器?");
            if (c == true) {
                var lightbox = new LightBox("正在重启，请稍后...", "重启路由器");
                $.getJSON("<%=luci.dispatcher.build_url("admin", "system", "reboot")%>",null,function(rsp) {
                    setTimeout("cRoute(0, '" + window.location.host + "');", 30000);
                })
            } else {
             //r = 1;
            }
        });

        //恢复出厂设置
        $("#reset").click(function () {
            var c = confirm("是否确定恢复出厂设置?");
            if (c == true) {
                var lightbox = new LightBox("正在恢复出厂设置，请稍后...", "恢复出厂设置");
                $.getJSON("<%=luci.dispatcher.build_url("admin", "system", "reset")%>",null,function(rsp) {
                    setTimeout("cRoute(0, '192.168.199.1');", 30000);
                })
            } else {
             //r = 1;
            }
        })

    })

    function loadSave(str, id){
        if(str == "before"){
            $("#" + id).attr("disabled",true);
            $("#" + id).val("保存中...");
            $("." + id + "-loading").css("display","inline-block");
        }

        if(str == "after"){
            $("#" + id).attr("disabled",false);
            $("#" + id).val("保 存");
            $("." + id + "-loading").css("display","none");
        }
    }

    function objCopy(src) {
        var dest = {};

        for (var key in src) {
            dest[key] = typeof src[key] == 'object' ? objCopy(src[key]) : src[key];
        }

        return dest;
    }

    function cRoute(c, ip) {
        $.ajax({
            type: "GET",
            cache: false,
            url: "http://"+ ip +"/luci-static/resources/images/h_home.png",
            success: function(){
                window.location.href = "http://"+ ip +"/cgi-bin/luci";
            },
            ontimeout:function(){
                setTimeout("cRoute("+ c +", '"+ ip +"');", 2000);
            },
            error:function(){
                setTimeout("cRoute("+ c +", '"+ ip +"');", 2000);
            }
        });

        if (c++ > 10) window.location.href = "http://"+ ip +"/cgi-bin/luci";
    }
</script>